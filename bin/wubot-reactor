#!/usr/local/bin/perl -w
use strict;

use AnyEvent::Watchdog autorestart => 1, heartbeat => 300;

use AnyEvent;
use Getopt::Long;
use Sys::Hostname;
use YAML;

use Wubot::Logger;
my $logger = Log::Log4perl::get_logger( 'default' );

use Wubot::Config;
use Wubot::Reactor;
use Wubot::Reactor::MessagePoster;

my $message_directory = "$ENV{HOME}/wubot/reactor";

my $messenger = Wubot::LocalMessageStore->new();
my $poster    = Wubot::Reactor::MessagePoster->new();

my $reactor_config = "$ENV{HOME}/wubot/config/reactor.yaml";
$logger->info( "loading reactor config: $reactor_config" );
my $config = YAML::LoadFile( $reactor_config );

my $reactor = Wubot::Reactor->new( config => $config );

my $hostname = Sys::Hostname::hostname();
$hostname =~ s|\..*$||;

$logger->info( "Setting up timer..." );
my $end = AnyEvent->condvar;

my $timer = AnyEvent->timer( after    => 1,
                             interval => 5,
                             cb       => sub {

                                 while ( my $message = $messenger->get( $message_directory ) ) {
                                     react( $message );
                                 }
                             },
                         );

$logger->error( "Running..." );
$end->recv;
$logger->error( "Ended..." );


sub react {
    my ( $message ) = @_;

    $logger->debug( "Message received from: $message->{key}" );

    $reactor->react( $message );

    # if the message originated on this host, and the 'no_post' option
    # is not set, then forward the message to my App::Wubot instance
    if ( $message->{hostname} eq $hostname && ! $message->{no_post} ) {

        $poster->react( $message,
                        { url => 'http://wubot/cgi-bin/wubot-message.cgi', },
                    );
    }

}
